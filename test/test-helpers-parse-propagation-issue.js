let assert = require('chai').assert
const path = require('path')
let mockdate = require('mockdate')

describe('parse-propagation-issue', function() {
    const script_path = path.resolve('./actions/helpers/pr-data-to-issue-body.js')
    const pr_data_to_issue_body = require(script_path)
    const script2_path = path.resolve('./actions/helpers/parse-propagation-issue.js')
    const parse_propagation_issue = require(script2_path)
    // months are 0-based, so 6 is for July, not June
    const current_date = new Date(2020, 6, 11, 12)

    beforeEach(() => {
        mockdate.set(current_date)
    })

    afterEach(() => {
        mockdate.reset()
    })

    it('parses valid propagation issue bodies correctly', function() {
        let testcases = [
            {
                msg: "with all the fields",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ],
                pr_data: {
                    filed_pr_url: "https://github.com/owner/repo/pull/42",
                    title: "some title",
                    owner: "owner",
                    repo: "repo",
                    pr: 13,
                    branch: "target-branch",
                    date: new Date(),
                    card_id: 1234,
                    commits: [
                        "0000000000000000000000000000000000000001",
                        "0000000000000000000000000000000000000002",
                        "0000000000000000000000000000000000000003",
                    ],
                },
            },
            {
                msg: "without optional filed-pr-url field",
                body: [
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ],
                pr_data: {
                    filed_pr_url: "",
                    title: "some title",
                    owner: "owner",
                    repo: "repo",
                    pr: 13,
                    branch: "target-branch",
                    date: new Date(),
                    card_id: 1234,
                    commits: [
                        "0000000000000000000000000000000000000001",
                        "0000000000000000000000000000000000000002",
                        "0000000000000000000000000000000000000003",
                    ],
                },
            },
            {
                msg: "without the optional card-id field",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ],
                pr_data: {
                    filed_pr_url: "https://github.com/owner/repo/pull/42",
                    title: "some title",
                    owner: "owner",
                    repo: "repo",
                    pr: 13,
                    branch: "target-branch",
                    date: new Date(),
                    card_id: 0,
                    commits: [
                        "0000000000000000000000000000000000000001",
                        "0000000000000000000000000000000000000002",
                        "0000000000000000000000000000000000000003",
                    ],
                },
            },
            {
                msg: "with all the required fields",
                body: [
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ],
                pr_data: {
                    filed_pr_url: "",
                    title: "some title",
                    owner: "owner",
                    repo: "repo",
                    pr: 13,
                    branch: "target-branch",
                    date: new Date(),
                    card_id: 0,
                    commits: [
                        "0000000000000000000000000000000000000001",
                        "0000000000000000000000000000000000000002",
                        "0000000000000000000000000000000000000003",
                    ],
                },
            },
            {
                msg: "ignores empty lines",
                body: [
                    "",
                    "title: some title",
                    "",
                    "",
                    "owner: owner",
                    "repo: repo",
                    "",
                    "",
                    "original-pr: 13",
                    "",
                    "branch: target-branch",
                    "",
                    "date: 2020-7-11",
                    "commits:",
                    "",
                    "",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "",
                    "",
                    "",
                    "0000000000000000000000000000000000000003",
                ],
                pr_data: {
                    filed_pr_url: "",
                    title: "some title",
                    owner: "owner",
                    repo: "repo",
                    pr: 13,
                    branch: "target-branch",
                    date: new Date(),
                    card_id: 0,
                    commits: [
                        "0000000000000000000000000000000000000001",
                        "0000000000000000000000000000000000000002",
                        "0000000000000000000000000000000000000003",
                    ],
                },
            },
        ]
        for (let testcase of testcases) {
            const result = parse_propagation_issue({
                body: testcase.body.join("\n"),
            })
            assert.isEmpty(result.errors, `testcase ${testcase.msg} failed (${result.errors})`)
            assert.deepEqual(result.pr_data, testcase.pr_data)
            const got_body = pr_data_to_issue_body({
                pr_data: result.pr_data,
            })
            valid_lines = []
            for (let line of testcase.body) {
                if (line.length > 0) {
                    valid_lines.push(line)
                }
            }
            assert.strictEqual(got_body, valid_lines.join("\n"), `testcase ${testcase.msg} failed`)
        }
    })

    it('fails on invalid propagation issue bodies', function() {
        let testcases = [
            {
                msg: "missing title",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "empty title",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: ",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated title",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: foo",
                    "title: foo",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "missing owner",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "empty owner",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: ",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated owner",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: bar",
                    "owner: bar",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "missing repo",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "empty repo",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: ",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated repo",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: baz",
                    "repo: baz",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "missing original-pr",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "empty original-pr",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: ",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated original-pr",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "original-pr is not a number",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: bogus",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "missing branch",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "empty branch",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: ",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated branch",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "missing date",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "empty date",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: ",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated date",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-07-11",
                    "date: 2020-07-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "bogus date",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: bogus-date",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "impossible date",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-13-42",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "missing commits",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                ].join("\n"),
            },
            {
                msg: "empty commits",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                ].join("\n"),
            },
            {
                msg: "bogus commits",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-7-11",
                    "card-id: 1234",
                    "commits:",
                    "boguscommitid"
                ].join("\n"),
            },
            {
                msg: "empty filed-pr-url",
                body: [
                    "filed-pr-url: ",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-07-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated filed-pr-url",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-07-11",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "empty card-id",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-07-11",
                    "card-id: ",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "duplicated card-id",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-07-11",
                    "card-id: 1234",
                    "card-id: 1234",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
            {
                msg: "bogus card-id",
                body: [
                    "filed-pr-url: https://github.com/owner/repo/pull/42",
                    "title: some title",
                    "owner: owner",
                    "repo: repo",
                    "original-pr: 13",
                    "branch: target-branch",
                    "date: 2020-07-11",
                    "card-id: bogus",
                    "commits:",
                    "0000000000000000000000000000000000000001",
                    "0000000000000000000000000000000000000002",
                    "0000000000000000000000000000000000000003",
                ].join("\n"),
            },
        ]
        for (let testcase of testcases) {
            const result = parse_propagation_issue({
                body: testcase.body,
            })
            assert.isNotEmpty(result.errors, `testcase ${testcase.msg} failed`)
        }
    })
})
